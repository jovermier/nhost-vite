events {
    worker_connections 1024;
}

http {
    # Basic MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    # Define upstream servers for each Nhost service
    upstream hasura {
        server local.hasura.local.nhost.run:443;
    }

    upstream auth {
        server local.auth.local.nhost.run:443;
    }

    upstream storage {
        server local.storage.local.nhost.run:443;
    }

    upstream dashboard {
        server local.dashboard.local.nhost.run:443;
    }

    upstream functions {
        server local.functions.local.nhost.run:443;
    }

    upstream mailhog {
        server local.mailhog.local.nhost.run:443;
    }

    # Get the correct proxy URL for Codespaces or localhost
    map $http_host $proxy_base_url {
        ~^(.+)-8081\.(.+)$ "https://$1-8081.$2";
        ~^(.+)-8082\.(.+)$ "https://$1-8082.$2";
        ~^(.+)-8083\.(.+)$ "https://$1-8083.$2";
        ~^(.+)-8084\.(.+)$ "https://$1-8084.$2";
        ~^(.+)-8085\.(.+)$ "https://$1-8085.$2";
        ~^(.+)-8086\.(.+)$ "https://$1-8086.$2";
        default "http://localhost:$server_port";
    }

    # Hasura proxy server on port 8081
    server {
        listen 8081;
        server_name _;

        # Proxy all requests to Hasura
        location / {
            proxy_pass https://hasura;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.hasura.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Response rewriting
            proxy_redirect https://local.hasura.local.nhost.run/ $proxy_base_url/;
            
            # Enable response body rewriting for HTML, CSS, JS
            sub_filter 'https://local.hasura.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }

    # Auth proxy server on port 8082
    server {
        listen 8082;
        server_name _;

        location / {
            proxy_pass https://auth;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.auth.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect https://local.auth.local.nhost.run/ $proxy_base_url/;
            sub_filter 'https://local.auth.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }

    # Storage proxy server on port 8083
    server {
        listen 8083;
        server_name _;

        location / {
            proxy_pass https://storage;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.storage.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect https://local.storage.local.nhost.run/ $proxy_base_url/;
            sub_filter 'https://local.storage.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }

    # Dashboard proxy server on port 8084
    server {
        listen 8084;
        server_name _;

        location / {
            proxy_pass https://dashboard;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.dashboard.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect https://local.dashboard.local.nhost.run/ $proxy_base_url/;
            sub_filter 'https://local.dashboard.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }

    # Functions proxy server on port 8085
    server {
        listen 8085;
        server_name _;

        location / {
            proxy_pass https://functions;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.functions.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect https://local.functions.local.nhost.run/ $proxy_base_url/;
            sub_filter 'https://local.functions.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }

    # Mailhog proxy server on port 8086
    server {
        listen 8086;
        server_name _;

        location / {
            proxy_pass https://mailhog;
            proxy_ssl_verify off;
            proxy_ssl_server_name on;
            proxy_set_header Host local.mailhog.local.nhost.run;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_redirect https://local.mailhog.local.nhost.run/ $proxy_base_url/;
            sub_filter 'https://local.mailhog.local.nhost.run' '$proxy_base_url';
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript text/javascript application/json;
        }
    }
}
